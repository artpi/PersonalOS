name: PR Build and Playground ZIP

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  lint-php:
    if: ${{ github.event.pull_request.state == 'open' && github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR merge ref
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.number }}/merge
          fetch-depth: 0

      - name: Get changed PHP files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.php
            !vendor/**
            !node_modules/**

      - name: Set up PHP
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer
          extensions: mbstring, imap

      - name: Install Composer dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: composer install --no-interaction --no-progress --optimize-autoloader

      - name: Lint PHP files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Linting changed PHP files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          composer run lint -- ${{ steps.changed-files.outputs.all_changed_files }}

  lint-js:
    if: ${{ github.event.pull_request.state == 'open' && github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR merge ref
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.number }}/merge
          fetch-depth: 0

      - name: Get changed JS files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            src/**/*.js
            !node_modules/**
            !build/**

      - name: Set up Node.js
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install Node.js dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: npm ci

      - name: Lint JS files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Linting changed JS files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          npm run lint:js -- ${{ steps.changed-files.outputs.all_changed_files }}

  test:
    if: ${{ github.event.pull_request.state == 'open' && github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR merge ref
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.number }}/merge
          fetch-depth: 0

      - name: Setup dependencies
        uses: ./.github/actions/setup-deps

      - name: Setup WP-Env
        uses: ./.github/actions/setup-wp-env

      - name: Run PHP unit tests
        run: npm run test:unit:backend

  build-and-publish:
    if: ${{ github.event.pull_request.state == 'open' && github.event.pull_request.draft == false }}
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR merge ref
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.number }}/merge
          fetch-depth: 0

      - name: Build plugin
        id: build
        uses: ./.github/actions/build-plugin
        with:
          node-version: '20'
          php-version: '8.2'
          composer-no-dev: 'true'

      - name: Upload plugin ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: wp-personal-os-pr-${{ github.event.number }}
          path: ${{ steps.build.outputs.zip-path }}
          if-no-files-found: error
          compression-level: 9

      - name: Prepare deploy directory
        run: |
          deploy_dir="deploy/preview/${{ github.event.number }}"
          rm -rf "$deploy_dir"
          mkdir -p "$deploy_dir"
          cp "${{ steps.build.outputs.zip-path }}" "$deploy_dir/wp-personal-os.zip"

      - name: Upload ZIP via FTP
        env:
          FTP_USER: ${{ secrets.GH_ACTION_FTP_LOGIN }}
          FTP_PASS: ${{ secrets.GH_ACTION_FTP_PASS }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          ZIP_FILE="deploy/preview/${PR_NUMBER}/wp-personal-os.zip"
          if [ ! -f "$ZIP_FILE" ]; then
            echo "Error: ZIP file not found at $ZIP_FILE"
            exit 1
          fi
          curl -vvv --ftp-ssl --ftp-pasv --insecure --ssl-no-revoke --ftp-create-dirs \
            --user "$FTP_USER:$FTP_PASS" \
            --upload-file "$ZIP_FILE" \
            "ftp://s8.cyber-folks.pl/preview/${PR_NUMBER}/wp-personal-os.zip"

      - name: Comment preview links
        uses: marocchino/sticky-pull-request-comment@v2
        env:
          ARTIFACT_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          header: personalos-preview
          message: |
            ðŸš€ **Plugin build ready for testing**

            Artifact: [Download from workflow run](${{ env.ARTIFACT_RUN_URL }})

            Playground ZIP: `http://pr.personalos.net/preview/${{ github.event.number }}/wp-personal-os.zip`

            Launch in Playground: [Open WordPress Playground](https://playground.wordpress.net/?networking=yes#{%22steps%22:[{%22step%22:%22installPlugin%22,%22pluginData%22:{%22resource%22:%22url%22,%22url%22:%22http://pr.personalos.net/preview/${{ github.event.number }}/wp-personal-os.zip%22}}],%22landingPage%22:%22/wp-admin/admin.php?page=personalos-settings%22,%22login%22:true})

            Paste the ZIP URL into a WordPress Playground blueprint to load this PR build.
